---
title: "NFL Assignment"
#author: "ANONYMOUS (Keep it this way)"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
library( tidyverse )
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(echo = TRUE)

#Read in the data, note that we define several values in the original dataset as NA
nfl <- read_csv( "/Users/lucianadiasdemacedo/Downloads/S022/PSet_1_NFL_exploration/data/NFL-Census-Data-9.2.2013_clean.csv", 
                 na = c("NA","N/A","", "n/a", "#VALUE!") )
head (nfl)
```


# ~~~ Data Exploration ~~~

# 1. Find the highest and lowest salary in the dataset.

```{r}
# some code
nfl %>% 
    summarise( max_sal = max( Salary, na.rm = TRUE ), 
               min_sal = min( Salary, na.rm = TRUE ) )
# 2. Print the college and state for the five best paid players of the San Francisco 49ers
nfl %>% 
    filter( Team == "SF" )  %>% 
    arrange( desc( Salary ) ) %>% 
    select( College, State ) %>% 
    head(5)
```


# 3. Calculate the mean salary and number of players in the dataset for each position

Arrange your results from highest to lowest mean salary.

Hint: You might want some of the following code. You should also use the `group_by() + summarise()` combo.  Also use `summarise( n = n() )` to make a count of the number of records.

```{r}
clean.dat <- nfl %>% 
    filter( !is.na( Salary ) )
clean.dat %>%
    group_by( Position ) %>%
    summarise( mean_salary = mean( Salary ), number_of_players = n() ) %>%
    arrange( desc( mean_salary ) )
    
```


# 4. Determine if taller players get paid more

Use linear regression to answer this question.
For an overview of linear regression in R, see the course video and materials posted on Canvas.

Sometimes measures such as salary have such a skew that the outliers cause real problems.
For doing this question, you migth first try log transforming Salary via a mutate command to make `logSal = log( Salary )`, and then fitting your model on that space.

```{r, eval = FALSE}
# some code
# clean.dat <- nfl %>% 
#     filter( !is.na( Salary ) )
clean.dat <- clean.dat %>%
    mutate( logSal = log( Salary ) ) 

  
clean.dat <- clean.dat %>%
    mutate( logSal = log( Salary), Height = if_else(Height == "6;2/;", "6'2\"", Height ) )

model <- lm( logSal ~ Height, data = clean.dat )
summary( model )
exp( coef( model ) )

clean.dat <- clean.dat %>% 
    filter( !is.na( Height) )

# finally generate the plot again, and see if there's a relationship between height and log salary.

ggplot( clean.dat, mapping = aes( x = Height, y = logSal ) ) +
    geom_point() +
    geom_smooth( method = "lm", se = FALSE) 

# visually there's a slight positive relationship between height and log salary, but let's see what the regression says and if there's a statistically significant relationship.

model <- lm( logSal ~ Height, data = clean.dat )
summary( model )

exp( coef( model ) )

# the intercept is 5'10

```

Once you do, you can use `exp( coef )`, where `coef` is the coefficient from your regression, to get an interpretation of your coefficient as percent change in salary given a change in height.


# 5. Improve the linear model

What do you think about the results in (4)?  If you found differences, can you explain them by accounting for player position in your model?  In other words, what happens when you include position in your model?

```{r}
# some code
model_2 <- lm( logSal ~ Height + Position, data = clean.dat )
summary( model_2 )

exp( coef( model_2 ) )

# intercept is 5'10 and the position C


# when adding Position to the model as a control model, the coefficient for Height_cm is still positive but statistically insignificant (p-value above the threshold of 0.05), but the R-squared value has increased, which suggests that including Position in the model helps to explain more of the variation in log salary. This indicates that player position is an important factor in determining salary, and that height alone does not fully capture the differences in salary among players.


# the coefficient for Height_cm is positive, which suggests that taller players tend to have higher log salaries. The p-value for the coefficient is less than 0.05, which suggests that the relationship is statistically significant. However, the R-squared value is quite low, which suggests that height alone does not explain much of the variation in log salary. Should we interpret the Confidence Interval as well?

```

Some words of discussion go here.


# 6. Print the mean weight and height for the football players, calculated for each position

You are going to have to get height cleaned up.  You might try `separate()` (see R for DS) to make feet and inches, and then do some math via `mutate()`. You could also use `substring()`. In any case, you might find `parse_number()` a useful function. Note that one foot (abbreviated as ') is equal to 12 inches (abbreviated to ").
Try asking a Large Language Model for help with this one.

```{r}
# some code
# I already cleaned up the height in the previous question, so I can just use the clean.dat2 and Height_cm dataset to calculate the mean weight and height for each position. 
clean.dat <- clean.dat %>%
    separate( Height, into = c("feet", "inches"), sep = "'" ) %>%
    mutate( feet = parse_number( feet ), 
            inches = parse_number( inches ), 
            total_inches = feet * 12 + inches )


summarise( clean.dat, mean_weight = mean( Weight, na.rm = TRUE ), 
               mean_height = mean( total_inches, na.rm = TRUE ) ) 

```

\newpage

# ~~~ Visualizations ~~~

## 7. Make a graph with 3 variables: X axis, Y axis, and plot point coloring, that tells a story.

**please note:** we will be deducting points for messy plots, plots with poor labeling, or plots that are hard to read.  Make sure your plots are clear and easy to understand.

```{r}
# You pick the variables.  What would be interesting?
ggplot( clean.dat, mapping = aes( x = total_inches, y = logSal, color = Position ) ) +
    geom_point() +
    geom_smooth( method = "lm", se = FALSE) +
    labs( x = "Height (inches)", y = "Log Salary", color = "Position" )


clean.dat <- clean.dat %>%
    mutate( Side = case_when(
        Position %in% c("C", "FB", "OL", "QB", "RB", "TE", "WR") ~ "Offense",
        Position %in% c("CB", "DE", "DL", "LB", "NT", "S") ~ "Defense",
        Position %in% c("K", "LS", "P") ~ "Special Teams",
        TRUE ~ NA_character_
    ) )


# Plot with the new `Side` variable instead of `Position`/ 

### from Dylan's code: I really like this one, I think it makes the plot easier to read and understand, and it also tells a story about how different sides of the game might have different relationships between height and salary (Luciana)
ggplot( clean.dat, aes( x = total_inches, y = logSal, color = Side ) ) +
    geom_point() +
    geom_smooth( method = "lm", se = FALSE ) +
    labs( title = "Log Salary vs Height",
          x = "Height (inches)",
          y = "Log Salary" ) +
    theme(legend.position = "right")


# your code goes here
```

**7(B)** Explain what the plot tells us.

## 8. Make a graph with 4 variables that tells a story that your first plot does not.

For the four variables, perhaps you could use X axis, Y axis, plot point coloring, and plot point size, or perhaps plot point shape or some other attribute. **Do not** use any facets yet.  Just a single plot.  Other than that constraint, you pick!

```{r}
# some code

clean.dat <- clean.dat %>%
  filter(!is.na(Race))

# from Lydia's code
clean.dat <- clean.dat %>%
  mutate(Race = if_else(Race == "Pacific Islander",
                        "Asian/Pacific Islander",
                        Race)) %>%
    mutate(Race = if_else(Race %in% c("Native American", "Other", "Iranian"), "Other", Race))

dim(clean.dat)

ggplot(clean.dat, aes(x = Experience, y = logSal, color = Race)) +
  geom_point(aes(size = Age), alpha = 0.6) +     # make points partly transparent (asked chatgpt)
  geom_smooth(method = "lm", se = FALSE) +        
  labs(
    title = "Log Salary vs Experience by Race",
    x = "Experience (years)",
    y = "Log Salary",
    size = "Age"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

**8(B)** What does this plot tell us that the other plot doesn't?

## 9. When might we prefer simpler plots with fewer moving pieces to more complicated plots?



## 10. Now extend or modify your plot by making multiple plots in the same window.

You want to use either `facet_wrap()` or `facet_grid()` here.

```{r}
# some code


ggplot( clean.dat, mapping = aes( x = total_inches, y = logSal, color = Race ) ) +
    geom_point() +
    labs( x = "Height (cm)", y = "Log Salary", color = "Position" ) +
    facet_wrap( ~ Position ) +
    theme(legend.position = "bottom")
```

**10(B)** Compared to your prior plots, does this plot make anything easier to see?  Harder to see?


## 11. I'd like to know if taller players are paid more in some positions but not others. Make a plot to answer that question. 

```{r}
# some code (co-pilot did this one for me)
ggplot( clean.dat, mapping = aes( x = total_inches, y = logSal ) ) +
    geom_point() +
    geom_smooth( method = "lm", se = FALSE) +
    labs( x = "Height", y = "Log Salary" ) +
    facet_wrap( ~ Position )
```


**11(B).** What does your plot say?


\newpage

# ~~~ A touch of modeling ~~~

## 12. (2 pts) Make a predictive model (using OLS) to predict log salary using some set of other covariates and print out a summary of the model. Specify how you decided to treat missing data. 


```{r}
# some code (co-pilot + na.action = na.omit was suggested by ChatGPT)

# I was cleaning na when fitting the model, so I got an error saying: ! Can't recycle input of size 1743 to size 1745. Then ChatGPT suggested to clean the data before fitting the model.

clean2 <- na.omit(clean.dat)
dim(clean2)

model_final <- lm( 
  logSal ~ Experience + Age + Position, 
  data = clean2,
  na.action = na.omit)

clean2$pred_logSal <- predict(model_final)

summary( model_final )
```

## 13. Make a plot showing predictions vs actual, and also make a residual plot. 

```{r}
# some code
clean2 <- clean2 %>%
  filter(complete.cases(Experience, Age, Position))

# the above line was suggested by chatgpt after failing to filter na in multiple variables.

ggplot( clean2, aes( x = predict( model_final ), y = logSal , color = Experience) ) +
    geom_point() +
    geom_abline( slope = 1, intercept = 0, col = "red" ) +
    labs( y = "Actual Log Salary", x = "Predicted Log Salary" )


# from Lydia's code
ggplot( clean2, aes( x = predict( model_final ), y = resid( model_final ), color = Experience ) ) +
    geom_point() +
    geom_smooth( method = "loess", se = FALSE ) +
    geom_hline( yintercept = 0, col = "red" ) +
    labs( x = "Predicted Log Salary", y = "Residuals" )
```


**13(B)** Do these plots show any problems?


## 14. How old do players get?

Make a distribution of the ages of players in the dataset, and then speculate about how long a player might be able to play in the NFL.

```{r}

# from Lydia's code
clean.dat %>%
    ggplot( aes( x = Age ) ) +
    geom_histogram( binwidth = 1, fill = "lightblue", color = "black" ) +
    labs( title = "Distribution of Player Ages",
          x = "Age",
          y = "Count" )

# Let's use the 75th percentile to estimate the age of retirement for NFL players.  We can calculate this using the `quantile()` function.

quantile( clean.dat$Age, probs = 0.75, na.rm = TRUE )

summary( clean.dat$Age, na.rm = TRUE)
```

Your answer here.

**14(B).** Poke around on the internet to see what a typical age of retirement is.  How did that compare to your own assessment?


## 15. (2 pts) Use these data and your work to predict what average lifetime earnings would be for a median level pay NFL player.

```{r}
# some code
```

Be sure to explain your reasoning.


\newpage

# ~~~ Extensions ~~~

In this part of the assignment we offer two, very open ended, extensions.
They represent a reasonable amount of work, but are only worth 2 points---in other words, you can choose to do them if you want to go above and beyond, but you can still get a fine grade without doing them at all.
We will only grade at most one extension, and we will grade the first we see.

Both extensions relate to a second dataset, `Master-Player-List-2024.csv`, that you have in the data folder.

## Extension Option 1. Comparing to a more modern dataset.

How much more are players paid now, compared to 2013?
Try to account for differences in the datasets in terms of, for example, age and experience of the players in each dataset.
Write up your results using at least one visualization and some text explaining any analysis you did.



## Extension Option 2. Out of Sample Prediction

Using the 2013 data as a training set, try to predict salaries in the 2024 data with your linear model.
Then assess how well your 2013 predictions work.
One measure is the "Root Mean Square Error" (RMSE), which is defined as follows:
$$ RMSE = \sqrt{ \frac{1}{n} \sum_{i=1}^n ( y_i - \hat{y}_i )^2 } $$

where $y_i$ is the actual salary, $\hat{y}_i$ is the predicted salary, and $n$ is the number of players in the 2024 dataset.

**Hint:** You will need to do some data cleaning to get the two datasets to line up.
In particular, rename variables so they have the same names.


