---
title: "NFL Assignment"
#author: "ANONYMOUS (Keep it this way)"
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library( tidyverse )
knitr::opts_chunk$set(echo = TRUE)

#Read in the data, note that we define several values in the original dataset as NA
nfl <- read_csv( "data/NFL-Census-Data-9.2.2013_clean.csv", 
                 na = c("NA","N/A","", "n/a", "#VALUE!") )

```

# \~\~\~ Data Exploration \~\~\~

# 1. Find the highest and lowest salary in the dataset.

```{r}
# Highest and lowest salary

#base R
max(nfl$Salary, na.rm = TRUE)

min(nfl$Salary, na.rm = TRUE)

#tidyverse way 
nfl %>% 
    summarise( max_sal = max( Salary, na.rm = TRUE ), 
               min_sal = min( Salary, na.rm = TRUE ) )

# Answer: The highest salary is $20,100,000 and the lowest salary is $48,333.

```

# 2. Print the college and state for the five best paid players of the San Francisco 49ers

```{r}

nfl %>% 
    filter( Team == "SF" )  %>% 
    arrange( desc( Salary ) ) %>% 
    select( "Player Name", College, State ) %>% 
    head(5)


```

# 3. Calculate the mean salary and number of players in the dataset for each position

Arrange your results from highest to lowest mean salary.

Hint: You might want some of the following code.
You should also use the `group_by() + summarise()` combo.
Also use `summarise( n = n() )` to make a count of the number of records.

```{r}

# Create a cleaned dataframe with NAs removed from Salary column

clean.dat <- nfl %>% 
    filter( !is.na( Salary ) )

clean.dat %>% 
    group_by( Position ) %>% 
    summarise( mean_salary = mean( Salary ), count = n() ) %>% 
    arrange( desc( mean_salary ) )

```

# 4. Determine if taller players get paid more

Use linear regression to answer this question.
For an overview of linear regression in R, see the course video and materials posted on Canvas.

Sometimes measures such as salary have such a skew that the outliers cause real problems.
For doing this question, you might first try log transforming Salary via a mutate command to make `logSal = log( Salary )`, and then fitting your model on that space.

```{r}
# Add logSal variable and clean up a data point with a typo

clean.dat <- clean.dat %>%
    mutate( logSal = log( Salary), Height = if_else(Height == "6;2/;", "6'2\"", Height ) )


model <- lm( logSal ~ Height, data = clean.dat )
summary( model )
exp( coef( model ) )

```

Once you do, you can use `exp( coef )`, where `coef` is the coefficient from your regression, to get an interpretation of your coefficient as percent change in salary given a change in height.

Notes on our model: When fitting a model to understand whether height is associated with salary, it’s usually better to treat both salary and age as continuous numeric variables.
In the current model and plot, height is treated as a categorical variable, which makes the interpretation of the height–salary relationship more complicated.
The plot doesn't communicate much, as the categorical variables were sorted into alphabetical order, not according to their magnitude.

With the model using categorical variables, we have the height 5'10 set as the intercept, meaning that we estimate that players with that height will make on average US\$1,121,370, while players who are Height 6'2" and above will have higher salaries than the shorter players. However, none of these coefficients are statistically significant, apart from the players measuring 6'7" (t(d = 1730) = 2.18, p=0.029), who will on average make 1.5 times more than the players measuring 5'10. 

# 5. Improve the linear model

What do you think about the results in (4)?
If you found differences, can you explain them by accounting for player position in your model?
In other words, what happens when you include position in your model?

```{r}
# Create a new model that incorporates both Position and Height

model <- lm( logSal ~ Height + Position, data = clean.dat )
summary( model )
exp( coef( model ) )

```

After adding Position as a covariate, we're left with no categories of height having a statistical significance, which means that according to this model, when controlling for position, no categories of height are associated with higher salaries (in terms of statistical significance).
The only position that shows a somewhat statistically significant relationship with log salary is tight end (TE).
Rˆ2 increased from 0.002 to 0.015, in comparison with the previous model.
In other words, this model has a slightly better fit than the one with just height.
However, Rˆ2 is still very small.

# 6. Print the mean weight and height for the football players, calculated for each position

You are going to have to get height cleaned up.
You might try `separate()` (see R for DS) to make feet and inches, and then do some math via `mutate()`.
You could also use `substring()`.
In any case, you might find `parse_number()` a useful function.
Note that one foot (abbreviated as ') is equal to 12 inches (abbreviated to ").
Try asking a Large Language Model for help with this one.

```{r}
# Convert height into total inches

clean.dat <- clean.dat %>%
    separate( Height, into = c("feet", "inches"), sep = "'" ) %>%
    mutate( feet = parse_number( feet ), 
            inches = parse_number( inches ), 
            total_inches = feet * 12 + inches )

clean.dat %>% 
    group_by( Position ) %>% 
    summarise( mean_weight = mean( Weight, na.rm = TRUE ), 
               mean_height = mean( total_inches, na.rm = TRUE ) ) 

```

\newpage

# \~\~\~ Visualizations \~\~\~

## 7. Make a graph with 3 variables: X axis, Y axis, and plot point coloring, that tells a story.

**please note:** we will be deducting points for messy plots, plots with poor labeling, or plots that are hard to read.
Make sure your plots are clear and easy to understand.

```{r}
# You pick the variables.  What would be interesting?

# I want to combine player positions to create three categories: "Offense", "Defense", and "Special Teams".  I will use the following code to do this.  Note that I am using `case_when()` to create a new variable called `Side` that combines the original positions into these three categories.

clean.dat <- clean.dat %>%
    mutate( Side = case_when(
        Position %in% c("C", "FB", "OL", "QB", "RB", "TE", "WR") ~ "Offense",
        Position %in% c("CB", "DE", "DL", "LB", "NT", "S") ~ "Defense",
        Position %in% c("K", "LS", "P") ~ "Special Teams",
        TRUE ~ NA_character_
    ) )

# Plot with the new `Side` variable instead of `Position`
ggplot( clean.dat, aes( x = total_inches, y = logSal, color = Side ) ) +
    geom_point() +
    geom_smooth( method = "lm", se = FALSE ) +
    labs( title = "Salary vs Height",
          x = "Height (inches)",
          y = "Salary" ) +
    theme(legend.position = "right")

position.model = lm( logSal ~ total_inches + Side, data = clean.dat )
summary(position.model)
exp( coef( position.model ) )

side.model = lm( total_inches ~ Side, data = clean.dat)
summary(side.model)
exp( coef( side.model ))


```

**7(B)** Explain what the plot tells us.

## 8. Make a graph with 4 variables that tells a story that your first plot does not.

For the four variables, perhaps you could use X axis, Y axis, plot point coloring, and plot point size, or perhaps plot point shape or some other attribute.
**Do not** use any facets yet.
Just a single plot.
Other than that constraint, you pick!

```{r}
# some code

clean.dat <- clean.dat %>% 
    filter( !is.na( Race ) )

#combine Asian/Pacific Islander and Pacific Islander into one category called Asian/Pacific Islander, and Iranian, Native American, and Other into one category called Other.  I will use `case_when()` again to do this.

clean.dat <- clean.dat %>%
  mutate(Race = if_else(Race == "Pacific Islander",
                        "Asian/Pacific Islander",
                        Race)) %>%
    mutate(Race = if_else(Race %in% c("Native American", "Other", "Iranian"), "Other", Race))

ggplot( clean.dat, aes( x = total_inches, y = logSal, color = Race ) ) +
    geom_point(aes (size = Experience)) +
    geom_smooth( method = "lm", se = FALSE ) +
    labs( title = "Salary vs Height",
          x = "Height (inches)",
          y = "Salary" ) +
    theme(legend.position = "bottom")

```

**8(B)** What does this plot tell us that the other plot doesn't?

## 9. When might we prefer simpler plots with fewer moving pieces to more complicated plots?

## 10. Now extend or modify your plot by making multiple plots in the same window.

You want to use either `facet_wrap()` or `facet_grid()` here.

```{r}
# some code

ggplot( clean.dat, aes( x = total_inches, y = logSal, color = Race ) ) +
    facet_wrap(~Position) +
    geom_point() +
    labs( title = "Salary vs Height",
          x = "Height (inches)",
          y = "Log Salary") +
    theme(legend.position = "bottom")


```

**10(B)** Compared to your prior plots, does this plot make anything easier to see?
Harder to see?

## 11. I'd like to know if taller players are paid more in some positions but not others. Make a plot to answer that question.

```{r}
# some code

ggplot( clean.dat, aes( x = total_inches, y = logSal)) +
    facet_wrap(~Position) +
    geom_point() +
    geom_smooth( method = "lm", se = FALSE ) +
    labs( title = "Salary vs Height",
          x = "Height (inches)",
          y = "Log Salary" ) +
    theme(legend.position = "bottom")
```

**11(B).** What does your plot say?

\newpage

# \~\~\~ A touch of modeling \~\~\~

## 12. (2 pts) Make a predictive model (using OLS) to predict log salary using some set of other covariates and print out a summary of the model. Specify how you decided to treat missing data.

```{r}
# from Luciana

model_final <- lm( 
  logSal ~ Position + Age + Experience, 
  data = clean.dat,
  na.action = na.omit)

summary( model_final )


```

## 13. Make a plot showing predictions vs actual, and also make a residual plot.

```{r}
# from Luciana

clean.dat <- clean.dat %>%
  filter(complete.cases(Position, Age, Experience))

# the above line was suggested by chatgpt after failing to filter na in multiple varables.

ggplot( clean.dat, aes( x = logSal, y = predict( model_final ) ) ) +
    geom_point() +
    geom_abline( slope = 1, intercept = 0, col = "red" ) +
    labs( x = "Actual Log Salary", y = "Predicted Log Salary" )

length(predict(model_final))
nrow(clean.dat)
head(clean.dat)

# above is a frankstein of code from me, co-pilot, and chatgpt.
```

```{r}
# 1. Clean data for the model
model_dat <- clean.dat %>%
  filter(complete.cases(logSal, total_inches, Weight, Position, Age, Experience))

# 2. Fit model on *model_dat*
model_final <- lm(logSal ~ Position + Age + Experience,
                  data = model_dat)

# 3. Add predictions to *model_dat*
model_dat$pred <- predict(model_final)

# 4. Plot: guaranteed same rows, same order


ggplot(model_dat, aes(x = logSal, y = pred)) +
    scale_x_continuous(limits = c(12,17)) +
    scale_y_continuous(limits = c(12,17)) +
     labs(x = "Actual Log Salary", y = "Predicted Log Salary") +
  geom_point() +
    geom_smooth(method = "lm", se = FALSE) +
   geom_abline(slope = 1, col = "red") 

# LB note: I added the reference line to show what the line of fit should look like if there is a 1:1 correlation between predicted and actual salary. However, there is not! The blue and red lines have very different slopes.


# above is the suggestion from chatgpt to make sure that I'm comparing the predictions to the actual values for the same set of observations, since the model is only trained on a subset of the data that has complete cases for all the variables.


# residuals plot

ggplot( clean.dat, aes( x = predict( model_final ), y = resid( model_final ) ) ) +
    geom_point() +
    #geom_smooth( method = "loess", se = FALSE ) +
    geom_hline( yintercept = 0, col = "red" ) +
    labs( x = "Predicted Log Salary", y = "Residuals" )



```

**13(B)** Do these plots show any problems?

The residuals plot shows a slanted patterns, which indicates that our model does not fit the data well (the residuals should be randomly clustered around zero).

## 14. How old do players get?

Make a distribution of the ages of players in the dataset, and then speculate about how long a player might be able to play in the NFL.

```{r}
# some code

clean.dat %>%
    ggplot( aes( x = Age ) ) +
    geom_histogram( binwidth = 1, fill = "lightblue", color = "black" ) +
    labs( title = "Distribution of Player Ages",
          x = "Age",
          y = "Count" )

# Let's use the 75th percentile to estimate the age of retirement for NFL players.  We can calculate this using the `quantile()` function.

quantile( clean.dat$Age, probs = 0.75, na.rm = TRUE )

summary( clean.dat$Age, na.rm = TRUE)
    
```

Your answer here.

**14(B).** Poke around on the internet to see what a typical age of retirement is.
How did that compare to your own assessment?

From Dylan: The average age of retirement in the NFL is roughly 27.6 years.

## 15. (2 pts) Use these data and your work to predict what average lifetime earnings would be for a median level pay NFL player.

```{r}
# According to statista.com (https://www.statista.com/statistics/240102/average-player-career-length-in-the-national-football-league/?srsltid=AfmBOoqmPYi5zkjXX6DnUkiD1QaxzctbS5JcTA_lbZ8tMZEYbO0MzTjS) the average career length for an NFL player is 3.3 years, but it varies by position. 

# We need to reconcile these positions with the positions in our dataset, with help from ChatGPT to clarify which sub-positions fall into the broader position categories (initials added to the list by Lydia). 

table(clean.dat$Position)

# Not clearly indicated on the list from statista.com:
# C   DE   FB   LS  NT     S   
# Center, Defensive End, Fullback, Long Snapper, Nose Tackle, Safety

# List from statista.com, updated with missing positions based on ChatGPT's advice: 
# Kickers/punters (K, P, LS): 4.87 years
# Quarterbacks (QB): 4.44
# Offensive Linemen (OL, C): 3.63
# Defensive Linemen (DL, DE, NT): 3.24
# Linebackers (LB): 2.97
# Cornerbacks (CB, S): 2.94
# Tight Ends (TE): 2.85
# Wide receivers (WR): 2.81
# Running backs (RB, FB): 2.57
# Average across all positions: 3.3

#I want to create a new variable in my dataset that assigns the average career length to each player based on their position.

clean.dat <- clean.dat %>%
    mutate( Career_Length = case_when(
        Position %in% c("K", "P", "LS") ~ 4.87,
        Position == "QB" ~ 4.44,
        Position %in% c("OL", "C") ~ 3.63,
        Position %in% c("DL", "DE", "NT") ~ 3.24,
        Position == "LB" ~ 2.97,
        Position %in% c("CB", "S") ~ 2.94,
        Position == "TE" ~ 2.85,
        Position == "WR" ~ 2.81,
        Position %in% c("RB", "FB") ~ 2.57,
        TRUE ~ NA_real_
    ) )

# Now we need the median salary for each position. 

clean.dat %>% 
    group_by( Position ) %>% 
    summarise( median_salary = median( Salary, na.rm = TRUE ) ) 

# I'm going to make a new dataframe to make this easier

position_earnings <- clean.dat %>%
    group_by( Position ) %>%
    summarise( median_salary = median( Salary, na.rm = TRUE ), 
               career_length = first( Career_Length ), 
               count = n() ) %>%
    mutate( lifetime_earnings = median_salary * career_length )

head( position_earnings )

summary ( position_earnings )

# Now we need a weighted average of lifetime earnings by position, based on the proportion of positions in the NFL as a whole

position_earnings %>% 
    summarize(avg_lifetime = sum( (lifetime_earnings * count )/ sum( count )) )


# Average lifetime earnings for a median level pay NFL player would be approximately $2,814,507.

```

Be sure to explain your reasoning.

\newpage

# \~\~\~ Extensions \~\~\~

In this part of the assignment we offer two, very open ended, extensions.
They represent a reasonable amount of work, but are only worth 2 points---in other words, you can choose to do them if you want to go above and beyond, but you can still get a fine grade without doing them at all.
We will only grade at most one extension, and we will grade the first we see.

Both extensions relate to a second dataset, `Master-Player-List-2024.csv`, that you have in the data folder.

## Extension Option 1. Comparing to a more modern dataset.

How much more are players paid now, compared to 2013?
Try to account for differences in the datasets in terms of, for example, age and experience of the players in each dataset.
Write up your results using at least one visualization and some text explaining any analysis you did.

```{r}
nfl_24 <- read_csv( "data/Master-Player-List-2024.csv", 
                 na = c("NA","N/A","", "n/a", "#VALUE!") )

# Removing NAs from CapHit in 2024 dataset
clean.dat.24 <- nfl_24 %>% 
    filter( !is.na( CapHit ) )

# Creating Salary variable in 2024 dataset from CapHit
clean.dat.24 <- clean.dat.24 %>% 
    mutate( Salary = parse_number( CapHit ) )

# Finding the middle and average salary in both 2013 and 2024     
clean.dat %>% 
    filter( !is.na( Salary ) ) %>%
    summarise( mean_2013 = mean( Salary ), 
               median_2013 = median( Salary ) )
               
clean.dat.24 %>% 
    filter( !is.na( Salary ) ) %>%
    summarise( mean_2024 = mean( Salary ), 
               median_2024 = median( Salary ) )

# Cleaning height in 2024 dataset and creating total_inches variable  (CAN PROBABLY DELETE)             
clean.dat.24 <- clean.dat.24 %>%
    separate( Height, into = c("feet", "inches"), sep = "-" ) %>%
    mutate( feet = parse_number( feet ), 
            inches = parse_number( inches ), 
            total_inches = feet * 12 + inches )

# Creating logSal variable in 2024 dataset (CAN PROBABLY DELETE)
clean.dat.24 <- clean.dat.24 %>%
    mutate( logSal = log( Salary ) )

# Finding the mean height and weight in both 2013 and 2024 (CAN PROBABLY DELETE)
summarise( clean.dat, mean_weight = mean( Weight, na.rm = TRUE ), 
               mean_height = mean( total_inches, na.rm = TRUE ) ) 
summarise( clean.dat.24, mean_weight = mean( Weight, na.rm = TRUE ), 
               mean_height = mean( total_inches, na.rm = TRUE ) ) 

# Calculating the mean difference in pay between salaries in 2024 and 2013
pay_diff = mean( clean.dat.24$Salary ) - mean( clean.dat$Salary )
pay_diff

# Converting YrsExp variable in 2024 dataset to numeric, treating "R" as 0 years of experience
clean.dat.24 <- clean.dat.24 %>%
  mutate(
    Experience = ifelse(YrsExp == "R", "0", YrsExp),
    Experience= as.numeric(Experience) )

# Cleaning position in 2024 dataset and creating Side variable similar to 2013 dataset
clean.dat.24 <- clean.dat.24 %>%
    mutate( Side = case_when(
        Position %in% c("C", "FB", "OT", "OG", "QB", "RB", "C", "TE", "WR", "OL") ~ "Offense",
        Position %in% c("DB", "LB", "DE", "DT", "DL","CB", "NT", "SS", "FS", "OLB", "MLB", "ILB", "SAF") ~ "Defense",
        Position %in% c("K", "LS", "P") ~ "Special Teams",
        TRUE ~ NA_character_ ) )

# Cleaning position in 2024 dataset so that the positions are similar to 2013 dataset
clean.dat.position <- clean.dat.24 %>%
  mutate( Position = case_when(
      Position %in% c("OT", "OG", "OL") ~ "OL",
      Position == "C"                   ~ "C",
      Position == "FB"                  ~ "FB",
      Position == "QB"                  ~ "QB",
      Position == "RB"                  ~ "RB",
      Position == "TE"                  ~ "TE",
      Position == "WR"                  ~ "WR",
      Position %in% c("DB", "CB")       ~ "CB",
      Position %in% c("SS", "FS", "SAF") ~ "S",
      Position %in% c("LB", "OLB", "MLB", "ILB") ~ "LB",
      Position %in% c("DT", "DL")       ~ "DL",
      Position == "NT"                  ~ "NT",
      Position == "DE"                  ~ "DE",
      Position == "K"                  ~ "K",
      Position == "P"                  ~ "P",
      Position == "LS"                  ~ "LS",
      TRUE                              ~ NA_character_ ) )

# Creating one dataset that has the mean salary for each experience level in both 2013 and 2024, so we can compare them in a plot
exp.sum <- bind_rows(
  clean.dat %>%
    group_by(Experience) %>%
    summarise(mean_salary = mean(Salary, na.rm = TRUE) ) %>%
    mutate(year = "2013"),
  clean.dat.24 %>%
    group_by(Experience) %>%
    summarise(mean_salary = mean(Salary, na.rm = TRUE) ) %>%
    mutate(year = "2024") )

# Calculating the mean salary difference and percent change between 2013 and 2024 for player experience
exp.sum %>% 
  group_by( Experience ) %>% 
  summarise( mean_salary_2013 = mean( mean_salary[ year == "2013" ] ), 
             mean_salary_2024 = mean( mean_salary[ year == "2024" ] ) ) %>%
  mutate( salary_diff = mean_salary_2024 - mean_salary_2013 ) %>%
  mutate ( percent_diff = salary_diff / mean_salary_2013 * 100 ) %>%
  arrange( desc( percent_diff ) ) 

# Creating one dataset that has the mean salary for each side of the ball (offense, defense, special teams) in both 2013 and 2024, so we can compare them in a plot
side.sum <- bind_rows(
  clean.dat %>%
    group_by(Side) %>%
    summarise(mean_salary = mean(Salary, na.rm = TRUE) ) %>%
    mutate(year = "2013"),
  clean.dat.24 %>%
    group_by(Side) %>%
    summarise(mean_salary = mean(Salary, na.rm = TRUE) ) %>%
    mutate(year = "2024") )

# Calculating the mean salary difference and percent change between 2013 and 2024 for each side of the ball
side.sum %>% 
  group_by( Side ) %>% 
  summarise( mean_salary_2013 = mean( mean_salary[ year == "2013" ] ), 
             mean_salary_2024 = mean( mean_salary[ year == "2024" ] ) ) %>%
  mutate( salary_diff = mean_salary_2024 - mean_salary_2013 ) %>%
  mutate ( percent_diff = salary_diff / mean_salary_2013 * 100 ) %>%
  arrange( desc( percent_diff ) )

# Creating one dataset that has the mean salary for each position in both 2013 and 2024, so we can compare them in a plot
position.sum <- bind_rows(
  clean.dat %>%
    group_by(Position) %>%
    summarise(mean_salary = mean(Salary, na.rm = TRUE) ) %>%
    mutate(year = "2013"),
  clean.dat.position %>%
    group_by(Position) %>%
    summarise(mean_salary = mean(Salary, na.rm = TRUE) ) %>%
    mutate(year = "2024") )

# Calculating the mean salary difference and percent change between 2013 and 2024 for each position
position.sum %>% 
  group_by( Position ) %>% 
  summarise( mean_salary_2013 = mean( mean_salary[ year == "2013" ] ), 
             mean_salary_2024 = mean( mean_salary[ year == "2024" ] ) ) %>%
  mutate( salary_diff = mean_salary_2024 - mean_salary_2013 ) %>%
  mutate ( percent_diff = salary_diff / mean_salary_2013 * 100 ) %>%
  arrange( desc( percent_diff ) )

#### Plotting ####
# Plotting Average Salary differences between 2013 and 2024 based on years of experience
library(scales)
ggplot(exp.sum, aes(x = Experience, y = mean_salary, fill = year)) +
  geom_col(position = "dodge") +
  scale_y_continuous( labels = function(x) x / 1e6,
                     name   = "Average Salary (millions)" ) +
  labs( title = "Average Salary vs Experience in 2013 and 2024",
    x = "Years of Experience" )

# Plotting Average Salary differences between 2013 and 2024 based on side of the ball
ggplot(side.sum, aes(x = Side, y = mean_salary, fill = year)) +
  geom_col(position = "dodge") +
  scale_y_continuous( labels = function(x) x / 1e6,
                     name   = "Average Salary (millions)" ) +
  labs( title = "Average Salary vs Player Category in 2013 and 2024",
    x = "Player Category" )    

# Plotting Average Salary differences between 2013 and 2024 based on position
ggplot(position.sum, aes(x = Position, y = mean_salary, fill = year)) +
  geom_col(position = "dodge") +
  scale_y_continuous( labels = function(x) x / 1e6,
                     name   = "Average Salary (millions)" ) +
  labs( title = "Average Salary vs Position in 2013 and 2024",
    x = "Position" )
```

\`\`\`{r, eval=FALSE, include=FALSE}

## Extension Option 2. Out of Sample Prediction

Using the 2013 data as a training set, try to predict salaries in the 2024 data with your linear model.
Then assess how well your 2013 predictions work.
One measure is the "Root Mean Square Error" (RMSE), which is defined as follows: $$ RMSE = \sqrt{ \frac{1}{n} \sum_{i=1}^n ( y_i - \hat{y}_i )^2 } $$

where $y_i$ is the actual salary, $\hat{y}_i$ is the predicted salary, and $n$ is the number of players in the 2024 dataset.

**Hint:** You will need to do some data cleaning to get the two datasets to line up.
In particular, rename variables so they have the same names.
